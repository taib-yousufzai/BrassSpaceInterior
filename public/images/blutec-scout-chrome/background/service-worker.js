console.log("[Background] Blutec Scout v10.0 - Enhanced with Backend Proxy");let W=[],O=!1;const D="https://blutec-scout-be.blutec.ai/api";class Z{constructor(e="",t=""){this.title=e,this.image=t}}class U{constructor(e="",t=""){this.link=e,this.source=t}}class N{constructor(e="",t="",a=""){this.id=e,this.name=t,this.link=a}}class R{constructor(e="",t="",a="",o="",n="",c=""){this.borough=e,this.street=t,this.city=a,this.postalCode=o,this.state=n,this.country=c}}class G{constructor(e="",t=!1){this.name=e,this.enabled=t}}class q{constructor(e="",t="",a=[]){this.id=e,this.name=t,this.options=a}}class K{constructor(e="",t="",a=0,o="",n=[],c=""){this.name=e,this.profilePicture=t,this.rating=a,this.description=o,this.images=n,this.when=c}}class Q{constructor(){this.inputId="",this.link="",this.cid="",this.title="",this.categories=[],this.category="",this.address="",this.openHours={},this.popularTimes={},this.webSite="",this.phone="",this.plusCode="",this.reviewCount=0,this.reviewRating=0,this.reviewsPerRating={},this.latitude=0,this.longitude=0,this.status="",this.description="",this.reviewsLink="",this.thumbnail="",this.timezone="",this.priceRange="",this.dataId="",this.images=[],this.reservations=[],this.orderOnline=[],this.menu=new U,this.owner=new N,this.completeAddress=new R,this.about=[],this.userReviews=[],this.userReviewsExtended=[],this.emails=[]}haversineDistance(e,t){const o=e*Math.PI/180,n=t*Math.PI/180,c=this.latitude*Math.PI/180,l=this.longitude*Math.PI/180,h=c-o,y=l-n,d=Math.sin(h/2)*Math.sin(h/2)+Math.cos(o)*Math.cos(c)*Math.sin(y/2)*Math.sin(y/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}isWithinRadius(e,t,a){return this.haversineDistance(e,t)<=a}}function s(r,...e){if(!e||e.length===0)return null;let t=r;for(let o=0;o<e.length-1;o++){const n=e[o];if(!Array.isArray(t)||n>=t.length||(t=t[n],t==null))return null}const a=e[e.length-1];return!Array.isArray(t)||a>=t.length?null:t[a]}function V(r){try{const e=s(r,203,0);if(!e||!Array.isArray(e))return{};const t={};for(const a of e)try{if(!Array.isArray(a)||a.length<4)continue;const o=a[0],n=a[3];if(!Array.isArray(n))continue;const c=n.filter(l=>Array.isArray(l)&&l.length>0&&typeof l[0]=="string").map(l=>l[0]);typeof o=="string"&&c.length>0&&(t[o]=c)}catch(o){console.warn("⚠️ Error while processing item:",o)}return t}catch(e){return console.error("❌ Unexpected error in getHours:",e),{}}}function X(r){const e=s(r,84,0);if(!e||!Array.isArray(e))return{};const t={1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday",7:"Sunday"},a={};for(const o of e){if(!Array.isArray(o)||o.length<2)continue;const n=typeof o[0]=="number"?o[0]:0,c=Array.isArray(o[1])?o[1]:[],l={};for(const h of c)if(Array.isArray(h)&&h.length>=2){const y=typeof h[0]=="number"?h[0]:null,d=typeof h[1]=="number"?h[1]:null;y!==null&&d!==null&&(l[y]=d)}t[n]&&Object.keys(l).length>0&&(a[t[n]]=l)}return a}function F(r,e,t){if(!r||!Array.isArray(r))return[];const a=[];for(const o of r){if(!Array.isArray(o))continue;const n=e?s(o,...e):"",c=t?s(o,...t):"";c&&n&&a.push(new U(String(c),String(n)))}return a}function Y(r){if(!r||!Array.isArray(r))return[];const e=[];for(const t of r){const a=s(t,0);if(!a)continue;const o=s(a,1,4,5,0)||"";if(!o)continue;const n=s(a,1,4,5,1)||"",c=parseInt(s(a,2,0,0)||0),l=s(a,2,15,0,0)||"",h=s(a,2,2,0,1,21,6,8);let y="";h&&Array.isArray(h)&&h.length>=3&&(y=`${h[0]}-${h[1]}-${h[2]}`);const d=[],w=s(a,2,2,0,1,21,7);if(w&&Array.isArray(w))for(const f of w)typeof f=="string"&&f.length>2&&d.push(f.substring(2));const p=new K(o,n,c,l,d,y);e.push(p)}return e}function tt(r){const e=new Q,t=s(r,14);if(!t||!Array.isArray(t))return null;e.reviewCount=parseInt(s(t,4,8)||0),e.cid=s(t,10)||"",e.title=s(t,11)||"";const a=s(t,13);a&&Array.isArray(a)&&(e.categories=a.filter(p=>p).map(String),e.category=e.categories.length>0?e.categories[0]:"");const o=s(t,18)||"";e.address=o.replace(e.title+",","").trim(),e.openHours=V(t),e.popularTimes=X(t),e.webSite=s(t,7,0)||"",e.phone=s(t,178,0,1,1,0)||s(t,178,0,3)||s(t,178,0,0)||"",e.plusCode=s(t,183,2,2,0)||"",e.reviewRating=parseFloat(s(t,4,7)||0),e.latitude=parseFloat(s(t,9,2)||0),e.longitude=parseFloat(s(t,9,3)||0),e.status=s(t,34,4,4)||"",e.description=s(t,32,1,1)||"",e.reviewsLink=s(t,4,3,0)||"",e.thumbnail=s(t,72,0,1,6,0)||"",e.timezone=s(t,30)||"",e.priceRange=s(t,4,2)||"",e.dataId=s(t,10)||"",e.link=s(t,27)||"";const n=s(t,171,0);if(n&&Array.isArray(n)){for(const p of n)if(Array.isArray(p)){const f=s(p,2)||"",E=s(p,3,0,6,0)||"";E&&e.images.push(new Z(f,E))}}const c=s(t,46);c&&(e.reservations=F(c,[1],[0]));let l=s(t,75,0,1,2);l||(l=s(t,75,0,0,2)),l&&(e.orderOnline=F(l,[0,0],[1,2,0])),e.menu=new U(s(t,38,0)||"",s(t,38,1)||"");const h=s(t,57,2)||"",y=s(t,57,1)||"";e.owner=new N(h,y,h?`https://www.google.com/maps/contrib/${h}`:""),e.completeAddress=new R(s(t,183,1,0)||"",s(t,183,1,1)||"",s(t,183,1,3)||"",s(t,183,1,4)||"",s(t,183,1,5)||"",s(t,183,1,6)||"");const d=s(t,100,1);if(d&&Array.isArray(d))for(const p of d){if(!Array.isArray(p))continue;const f=new q(s(p,0)||"",s(p,1)||"",[]),E=s(p,2);if(E&&Array.isArray(E))for(const B of E){const A=s(B,1)||"",C=(s(B,2,1,0,0)||0)===1;A&&f.options.push(new G(A,C))}e.about.push(f)}e.reviewsPerRating={1:parseInt(s(t,175,3,0)||0),2:parseInt(s(t,175,3,1)||0),3:parseInt(s(t,175,3,2)||0),4:parseInt(s(t,175,3,3)||0),5:parseInt(s(t,175,3,4)||0)};const w=s(t,175,9,0,0);return w&&(e.userReviews=Y(w)),e.title?e:null}function et(r){const e=[];let t=r.trim();for(;t.startsWith(`
`);)t=t.substring(1);if(t.startsWith(")]}")){const n=t.indexOf("[");n>0&&(t=t.substring(n))}let a;try{a=JSON.parse(t)}catch(n){throw console.error(`JSON Parse Error: ${n}`),console.error(`First 500 chars: ${t.substring(0,500)}`),new Error(`Invalid JSON: ${n}`)}if(!Array.isArray(a)||a.length<2)throw new Error("Invalid JSON structure");const o=a.length>0?a[0][1]:[];if(!Array.isArray(o)||o.length===0)throw new Error("No results found in response");for(let n=0;n<o.length;n++){const c=o[n];if(!(!Array.isArray(c)||c.length<15))try{const l=tt(c);l&&e.push(l)}catch(l){console.error(`Error parsing entry ${n+1}: ${l}`);continue}}return e}function z(r){try{return et(r)}catch(e){throw console.error(`❌ Error parsing Google Maps response: ${e}`),e}}async function J(){return new Promise(r=>{chrome.storage.local.get(["authToken"],e=>{r(e.authToken||null)})})}async function rt(r){try{const e=await J();if(!e)return console.error("[Background] No auth token found"),!1;const a=await(await fetch(`${D}/subscription/increment-leads`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({count:r})})).json();return a.success?!0:(console.error("[Background] Increment leads failed:",a.message),!1)}catch(e){return console.error("[Background] Failed to update lead usage:",e),!1}}function L(r){return new Promise(e=>setTimeout(e,r))}chrome.runtime.onMessage.addListener((r,e,t)=>{if(r.action==="fetchWebsite")return at(r.websites,t),!0;if(r.action==="startScrape")return ot(r.data,t),!0;if(r.action==="parseData"&&st(r.data,t),r.action==="logs"&&t({success:!0}),r.action==="getScrapedData")return t({success:!0,data:W}),!0;if(r.action==="openSubscriptionPlans")return chrome.tabs.create({url:chrome.runtime.getURL("subscription-plans.html")}),t({success:!0}),!0;if(r.action==="stopScraping")return O=!0,t({success:!0}),!0});function st(r,e){try{if(!r||r.length===0){console.error("[Background] Empty HTML data received"),e({success:!1,error:"Empty HTML data",data:[]});return}const t=z(r);e({success:!0,data:t})}catch(t){console.error("[Background] Error parsing data:",t),console.error("[Background] Error stack:",t.stack),e({success:!1,error:t.message,data:[]})}}async function at(r,e){try{const t=new AbortController,a=setTimeout(()=>t.abort(),6e4),n=await fetch("https://blutec-scout-backend.blutec.ai/api/get-details",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({websites:r}),credentials:"omit",signal:t.signal});if(clearTimeout(a),!n.ok)throw new Error(`HTTP ${n.status}`);const c=await n.json();if(!c.success)throw new Error(c.message||"Scraping failed");e({success:!0,results:c.results,successCount:c.successCount,totalWebsites:c.totalWebsites})}catch(t){t.name==="AbortError"?(console.error("[Background] Timeout scraping batch"),e({success:!1,error:"Timeout"})):(console.error(`[Background] Scraping error: ${t.message}`),e({success:!1,error:t.message}))}}async function ot(r,e){var t,a;try{const o=await J();if(!o){e({success:!1,error:"Authentication required. Please log in first."});return}const c=await(await fetch(`${D}/subscription/check-lead-usage`,{method:"GET",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).json();if(!c.success){e({success:!1,error:"Failed to check lead usage. Please try again."});return}const l=c.remaining;if(l<=0){e({success:!1,error:"Lead limit reached. Please upgrade your plan or start a free trial."});return}W=[],O=!1;const{query:h,location:y,maxPages:d}=r,w=y?`${h} ${y}`:h,p=`https://www.google.com/maps/search/${encodeURIComponent(w)}`,f=await chrome.tabs.create({url:p,active:!1});if(await ct(f.id),await L(3e3),await chrome.scripting.executeScript({target:{tabId:f.id},files:["content/content-script.js"]}),await L(2e3),!((t=(await chrome.scripting.executeScript({target:{tabId:f.id},func:()=>typeof window.BlutecAPI<"u"}))[0])!=null&&t.result))throw new Error("BlutecAPI not loaded in content script");e({success:!0,message:"Scraping started"});const B=[];let A=0;const C=Math.min(l,d*20);for(let u=0;u<d&&!(O||A>=C);u++){try{chrome.runtime.sendMessage({action:"scrapingProgress",stage:"scraping_places",progress:{currentPage:u+1,totalPages:d,leadsUsed:A,maxLeads:C}})}catch{}const $=((a=(await chrome.scripting.executeScript({target:{tabId:f.id},func:async I=>{if(!window.BlutecAPI)return{success:!1,error:"BlutecAPI not available"};const i=window.BlutecAPI.getCurrentMapCoords?window.BlutecAPI.getCurrentMapCoords():{latitude:23.0225,longitude:72.5714,zoom:12},T=window.location.href;let j="restaurants";if(T.includes("/maps/search/"))try{j=decodeURIComponent(T.split("/maps/search/")[1].split("/")[0].replace(/\+/g," "))}catch(k){console.error("[Content] Error parsing query:",k)}const H=I*20;try{return{success:!0,html:await window.BlutecAPI.fetchPageData(j,i.latitude,i.longitude,i.zoom,H)}}catch(k){return{success:!1,error:k.message}}},args:[u]}))[0])==null?void 0:a.result)||{success:!1};if(!$.success){console.error(`[Background] Page ${u+1} failed`);continue}let P=[];try{$.html&&(P=z($.html).map(i=>({placeId:i.cid,name:i.title,phone:i.phone,phoneCountryCode:nt(i.phone),website:i.webSite,address:i.address,category:i.category,rating:i.reviewRating,reviewCount:i.reviewCount,latitude:i.latitude,longitude:i.longitude,thumbnail:i.thumbnail,mondayHours:i.openHours.Monday?i.openHours.Monday.join(", "):"",tuesdayHours:i.openHours.Tuesday?i.openHours.Tuesday.join(", "):"",wednesdayHours:i.openHours.Wednesday?i.openHours.Wednesday.join(", "):"",thursdayHours:i.openHours.Thursday?i.openHours.Thursday.join(", "):"",fridayHours:i.openHours.Friday?i.openHours.Friday.join(", "):"",saturdayHours:i.openHours.Saturday?i.openHours.Saturday.join(", "):"",sundayHours:i.openHours.Sunday?i.openHours.Sunday.join(", "):"",timezone:i.timezone,completeAddress:i.completeAddress,emails:[]})))}catch(I){console.error(`[Background] Parse error page ${u+1}:`,I),P=[]}if(P.length===0)break;const m=C-A,b=P.slice(0,m);if(B.push(...b),A+=b.length,b.length<P.length)break;await L(1500)}const g=it(B);try{chrome.runtime.sendMessage({action:"placesScrapingComplete",data:g,stats:{total:g.length,phones:g.filter(u=>u.phone).length,websites:g.filter(u=>u.website).length}})}catch{}const v=g.filter(u=>u.website&&u.website.trim()!=="").map(u=>u.website);if(v.length>0){const S=Math.ceil(v.length/5);for(let m=0;m<S&&!O;m++){const b=m*5,I=Math.min(b+5,v.length),i=v.slice(b,I);try{chrome.runtime.sendMessage({action:"emailScrapingProgress",stage:"scraping_emails",progress:{currentBatch:m+1,totalBatches:S,processedWebsites:I,totalWebsites:v.length}})}catch{}try{const T=new AbortController,j=setTimeout(()=>T.abort(),6e4),H=await fetch(`${D}/get-details`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({websites:i}),credentials:"omit",signal:T.signal});if(clearTimeout(j),!H.ok)throw new Error(`HTTP ${H.status}`);const k=await H.json();if(k.success&&k.results){k.results.forEach(M=>{if(M.success&&M.emails.length>0){const x=g.find(_=>_.website===M.url);x&&(x.emails=M.emails)}});try{chrome.runtime.sendMessage({action:"emailBatchComplete",data:g,batchInfo:{currentBatch:m+1,totalBatches:S}})}catch{}}}catch(T){console.error(`[Background] Batch ${m+1} error:`,T.message)}m<S-1&&await L(2e3)}const $=g.filter(m=>m.emails&&m.emails.length>0).length,P=g.reduce((m,b)=>m+(b.emails?b.emails.length:0),0)}W=g;try{await rt(A)}catch(u){console.error("[Background] Error updating lead usage:",u)}setTimeout(()=>{chrome.tabs.remove(f.id)},1e3);try{chrome.runtime.sendMessage({action:"scrapingComplete",data:g,stats:{total:g.length,phones:g.filter(u=>u.phone).length,websites:g.filter(u=>u.website).length,emails:g.filter(u=>u.emails&&u.emails.length>0).length,totalEmails:g.reduce((u,S)=>u+(S.emails?S.emails.length:0),0)}})}catch{}}catch(o){console.error("[Background] Scraping failed:",o.message);try{chrome.runtime.sendMessage({action:"scrapingError",error:o.message})}catch{}}}function nt(r){if(!r)return"";const e=r.match(/^\+(\d{1,3})/);return e?`+${e[1]}`:r.startsWith("91")&&r.length>=12?"+91":r.startsWith("1")&&r.length===11?"+1":r.startsWith("44")&&r.length>=12?"+44":""}function it(r){const e=new Set,t=[];for(const a of r)!a||!a.placeId||e.has(a.placeId)||(e.add(a.placeId),t.push(a));return t}function ct(r){return new Promise(e=>{const t=(a,o)=>{a===r&&o.status==="complete"&&(chrome.tabs.onUpdated.removeListener(t),e())};chrome.tabs.onUpdated.addListener(t)})}
